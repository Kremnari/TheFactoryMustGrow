(window.webpackJsonp=window.webpackJsonp||[]).push([[6],{iVpH:function(e,t,r){"use strict";var i=r("7jDb"),s=r("6juG"),n=function(e,t,r){return t.buffers={},Object.assign(t,r.data.entity[e.name]),"miner"!=t.subType&&"crafter"!=t.subType||(t.buffers.out=r.newComponent("entity.buffer",{dir:"out"},t)),"crafter"!=t.subType&&"research"!=t.subType||("research"==t.subType?(t.buffers.in=r.newComponent("entity.buffer",{staticStacks:t.inputs,dir:"in"},t),t.research_timer=null,t.$_tags.push("researchTicker",!0)):t.buffers.in=r.newComponent("entity.buffer",{dir:"in"},t)),t.order=e.idx,[t]};n._delete=function(e,t){e.buffers.in&&t.deleteObject(e.buffers.in),e.buffers.out&&t.deleteObject(e.buffers.out)},i.a.defineObj("player.entity",n,{tick:function(e,t,r){if(e.processing)if(Number.isNaN(e.process_timer)||null===e.process_timer)"miner"==e.subType||r.processTEMP(e.buffers.in,"inventory.consume",{itemStacks:e.processing.ingredients})?e.process_timer=e.process_ticks:e.$_tags.delete("tick");else{if(e.process_timer&&--e.process_timer,e.process_timer<=0){var i=r.getId(e.buffers.out);r.processTEMP(i,"inventory.add",{itemStacks:e.buffers.stalled||e.processing.results||{name:e.processing.mining_results,count:1}}).complete?e.process_timer=NaN:e.$_tags.delete("tick")}r.view.signaler.signal("bufferUpdate")}else e.$_tags.delete("ticking")}}),i.a.addObjectTickHandler("player.entity",(function(e,t,r){var i=r.getNamedObject("research").progressing;if(i){if(Number.isNaN(e.research_timer)||null===e.research_timer){var s;if(!i.cost.ingredients.every((function(t){var i=t[0],s=t[1];return r.processTEMP(e.buffers.in,"inventory.total",{name:i})>=s})))return;i.cost.ingredients.forEach((function(t){var i=t[0],s=t[1];r.processTEMP(e.buffers.in,"inventory.consume",{itemStacks:{name:i,count:s}})}));var n=r.getId(e.buffers.in);return(null==n||null==(s=n.upgrades.loader)?void 0:s.count)&&n.$_tags.push("tick","processing"),e.research_time=i.cost.time*r.config.TICKS_PER_SECOND*e.researching_speed,void(e.research_timer=e.research_time)}e.research_timer&&--e.research_timer,e.research_timer<=0&&(r.processTEMP(i,"research.update",{}),e.research_timer=NaN),r.view.signaler.signal("bufferUpdate")}}),"researchTicker",{chain:["tick","researchTicker"],num:3});var c=function(e,t,r){r.res?(window.clearTimeout(r.timeout),t.view.animsUpdate(r.res,null,null),r.res=void 0):(r.timeout=window.setTimeout((function(){t.processTEMP(e.player.inventory,"inventory.add",{itemStacks:[{name:e.which.resource.mining_results,count:1}]}),t.view.animsUpdate(r.res,null,null),r.res=void 0}),1e3*e.which.resource.mining_time),r.res=e.which.resource,t.view.animsUpdate(e.which.resource,"isMining",e.which.resource.mining_time))};window.ResourceMine=c,c.signature={which:"resource",player:"inventory"},i.a.provide_CCC("resources.mine",c,c.signature);i.a.provide_CCC("entity.setProcess",(function(e,t){if(!e.at.entity.processing&&null!=e.which.process||(t.processTEMP(e.at.entity,"entity.clearProcess",{returnTo:e.player.inventory}),e.which.process))if(e.at.entity.processing=e.which.process,e.at.entity.$_tags.push("tick","processing"),"mining"==e.type.class)e.at.entity.process_ticks=e.which.process.mining_time/e.at.entity.mining_speed*t.config.TICKS_PER_SECOND,e.at.entity.process_timer=e.at.entity.process_ticks;else if("crafting"==e.type.class){if(e.at.entity.process_ticks=e.which.process.crafting_speed/e.at.entity.crafting_speed*t.config.TICKS_PER_SECOND,e.at.entity.buffers.in){var r=t.getId(e.at.entity.buffers.in);if(r.stacks<e.which.process.ingredients.length)return t.view.warnToast("Recipe exceedes machines ingredient limit");e.which.process.ingredients.forEach((function(e,t){r.items[t]={name:e.name,count:0}}))}if(e.at.entity.buffers.out){var i=t.getId(e.at.entity.buffers.out);if(i.stacks<e.which.process.results.length)return t.view.warnToast("Recipe exceedes machines results limit");e.which.process.results.forEach((function(e,t){i.items[t]={name:e.name,count:0}}))}e.at.entity.process_timer=NaN}}),{at:"entity",which:"process",type:"class",player:"inventory"}),i.a.addOperation("entity.clearProcess",(function(e,t,r,i){if(e.buffers.in){e.process_timer&&i.processTEMP("player.inventory","inventory.add",{itemStacks:e.processing.ingredients});var s=i.getId(e.buffers.in);i.processTEMP("player.inventory","inventory.add",{itemStacks:s.items}),//! If args.returnTo is full, 'inventory.add' will fail silently
s.items.length=0,s.xferStack=0,s.stalled=!1}if(e.buffers.out){var n=i.getId(e.buffers.out);i.processTEMP("player.inventory","inventory.add",{itemStacks:n.items}),//! If args.returnTo is full, 'inventory.add' will fail silently
n.items.length=0,n.xferStack=0,n.stalled=!1}e.buffers.stalled&&(i.processTEMP("player.inventory","inventory.add",{itemStacks:e.buffers.stalled}),e.buffers.stalled=null),e.processing=null})),i.a.setStatic("entityBuffer.sizeExpansionCost",[{name:"iron-chest",count:1}]),i.a.setStatic("entityBuffer.xferExpansionCost",[{name:"inserter",count:1}]);var a=function(e,t,r){var i,s;return t.upgrades={maxBuffers:6,maxInserters:10},t.maxStacks=(null==(i=e.staticStacks)?void 0:i.length)||e.stacks||1,t.stackSize=e.stackSize||5,t.items=(null==(s=e.staticStacks)?void 0:s.map((function(e){return{name:e,count:0}})))||[],t.xfer=0,t.xferTicks=120,t.xferStack=0,t.busShift=0,t.xferTimer=NaN,t.restrictable=e.restrictable||!1,t.connection=null,t.dir=e.dir,t.active=!1,[t]};a._delete=function(e,t){var r,i,s=t.getNamedObject("player.inventory");(null==(r=e.upgrades.bufferSize)?void 0:r.count)&&t.processTEMP(s,"inventory.add",{itemStacks:t.getStatic("entityBuffer.sizeExpansionCost"),multi:e.upgrades.bufferSize.count}),(null==(i=e.upgrades.loader)?void 0:i.count)&&t.processTEMP(s,"inventory.add",{itemStacks:t.getStatic("entityBuffer.xferExpansionCost"),multi:e.upgrades.loader.count})};var o={Collect:function(e,t){var r,i=t.getId(e.which.buffer),s=i.items.findIndex((function(t){return t.name==e.item.name}));-1==s&&console.warn("Didnt' find the right index"),0!==i.items[s].count&&(t.processTEMP("player.inventory","inventory.add",{itemStacks:i.items[s]}),i.items[s].count=0,t.getId(i.$_parent).$_tags.push("tick","processing"),t.view.signaler.signal("bufferUpdate"),(null==(r=i.upgrades.loader)?void 0:r.count)&&i.$_tags.push("tick","processing"))}};o.Collect.signature={which:"buffer",item:"name"},o.Collect.CC_provide="entity.bufferCollect",o.Fill=function(e,t){var r,i=t.getId(e.which.buffer),s=i.items.findIndex((function(t){return t.name==e.item.name}));-1==s&&console.warn("Didnt' find the right index");var n=t.processTEMP("player.inventory","inventory.total",{name:i.items[s].name});if(0!==n){var c=e.service.rounder.calc(i.items[s].count,i.stackSize,n);t.processTEMP("player.inventory","inventory.consume",{itemStacks:{name:i.items[s].name,count:c}}),i.items[s].count+=c,t.getId(i.$_parent).$_tags.push("tick","processing"),t.view.signaler.signal("bufferUpdate"),(null==(r=i.upgrades.loader)?void 0:r.count)&&i.$_tags.push("tick","processing")}},o.Fill.signature={which:"buffer",item:"name",service:"rounder"},o.Fill.CC_provide="entity.bufferFill",o.ClickCycle=function(e,t){t.getId(e.which.buffer).items.find((function(t){return t.name==e.item.name}))},o.ClickCycle.signature={which:"buffer",item:"name",service:"rounder"},o.ClickCycle.CC_provide="entity.bufferCycle",i.a.setStatic("entity.buffer.BUFFER_SIZE",[5,10,10,10,20,20,20]),i.a.setStatic("entity.buffer.BUFFER_SIZE.MAX",25),o.Upgrade=function(e,t){var r=t.getId(e.which.buffer);if("autoload"==e.type.string){var i,s,n=(null==(i=e.cost)?void 0:i.stacks)||{name:"inserter",count:1};if((null==(s=r.upgrades.loader)?void 0:s.count)>=10)return t.view.warnToast("Loaders full");if(!t.processTEMP(e.player.inventory,"inventory.consume",{itemStacks:n}))return t.view.warnToast("Inserter required");!r.upgrades.loader&&(r.upgrades.loader={count:0}),r.upgrades.loader.count++,r.xferTimer||(r.xferTimer=r.xferTicks),r.xfer++,r.active=!0,r.$_tags.push("tick","processing")}else if("buffer"==e.type.string){var c,a,o=(null==(c=e.cost)?void 0:c.stacks)||{name:"iron-chest",count:1};if((null==(a=r.upgrades.bufferSize)?void 0:a.count)>=r.upgrades.maxBuffers)return t.view.warnToast("Chests full");if(!t.processTEMP(e.player.inventory,"inventory.consume",{itemStacks:o}))return t.view.warnToast("Cannot consume upgrade costs");!r.upgrades.bufferSize&&(r.upgrades.bufferSize={count:0}),r.upgrades.bufferSize.count++,r.stackSize+=t.getStatic("entity.buffer.BUFFER_SIZE")[r.upgrades.bufferSize.count-1]||t.getStatic("entity.buffer.BUFFER_SIZE.MAX"),t.getId(r.$_parent).$_tags.push("tick","processing")}},o.Upgrade.signature={which:"buffer",type:"string",player:"inventory","cost.stacks":{optional:!0}},o.Upgrade.CC_provide="entity.bufferUpgrade",o.SetRestrictions=function(e,t,r,i){e.restrictable||(r._result=!1);var s=[],n=[];e.maxStacks=t.list.length;for(var c=0;c<e.items.length;c++){var a=e.items[c];a?t.list.includes(a.name)?(s.push(a.name),a.restricted=!0):(a.count>0&&i.processTEMP("player.inventory","inventory.add",{itemStacks:a}),e.items.splice(c,1),n.push(c)):n.push(c)}t.list.forEach((function(t){s.includes(t)||(n.length>0?e.items.splice(n.splice(0,1),1,{name:t,count:0,restricted:!0}):e.items.push({name:t,count:0,restricted:!0}))})),e.busShift>e.items.length&&(e.busShift=0)},o.SetRestrictions.Igor_operation="buffer.restrictList",o.HasRestriction=function(e,t,r,i){e.restrictable?e.items.forEach((function(e){e.name==t.itemName&&(e.restrictedBy.includes(t.lineId)?r._result={found:!0,restricted:!0}:r._result={found:!0,restricted:!1})})):r._result=!1,!r._result&&(r._result={found:!1,restricted:!1})},o.HasRestriction.Igor_operation="buffer.hasRestriction",o.ClearRestriction=function(e,t,r,i){e.restrictable||(r._result=!1);for(var s=-1;!("_result"in r);){var n=e.items[++s];n.name==t.itemName&&(n.restrictedBy.splice(n.restrictedBy.indexOf(t.lineId),1),0==n.restrictedBy.length?(e.items.splice(s,1),r._result={found:!0,cleared:!0}):r._result={found:!0,cleared:!1})}!r._result&&(r._result={found:!1,cleared:!1})},o.ClearRestriction.Igor_operation="buffer.clearRestriction",o.BusXfer=function(e,t,r,i){var s=e.busShift;if(t.toBus){for(;t.xferCount>0&&0<e.items.length;)if(e.items[e.busShift]){var n=i.processTEMP(e,"inventory.total",{name:e.items[e.busShift].name}),c=i.processTEMP(t.toBus,"inventory.add",{itemStacks:[{name:e.items[e.busShift].name,count:Math.min(t.xferCount,n)}]});if(c.complete)i.processTEMP(e,"inventory.consume",{itemStacks:[{name:e.items[e.busShift].name,count:t.xferCount}]}),t.xferCount=0;else{if(n-c.part[0].count==0)
//! This point breaks the loop
return++e.busShift==e.items.length&&(e.busShift=0),void(r.full=!0);i.processTEMP(e,"inventory.consume",{itemStacks:[{name:e.items[e.busShift].name,count:n-c.part[0].count}]}),t.xferCount=c.part[0].count}++e.busShift==e.items.length&&(e.busShift=0)}else if(++e.busShift>=e.items.length&&(e.busShift=0),e.busShift==s)return;r.complete=!0}else if(t.fromBus){for(var a=0;t.xferCount>0;)if(e.items[e.busShift]){var o=e.stackSize-e.items[e.busShift].count;if(o){var u=i.processTEMP(t.fromBus,"inventory.consume",{itemStacks:[{name:e.items[e.busShift].name,count:Math.min(t.xferCount,o)}],partial:!0});u[0].count>0&&(i.processTEMP(e,"inventory.add",{itemStacks:[{name:e.items[e.busShift].name,count:u[0].count}]}),t.xferCount-=u[0].count)}if(++a==e.items.length)return void(r.full=!0);++e.busShift==e.items.length&&(e.busShift=0)}else if(++e.busShift>=e.items.length&&(e.busShift=0),e.busShift==s)return;r.complete=!0}else console.warn("BusXfer called __ no bus target")},o.BusXfer.Igor_operation="buffer.busXfer",o.BufferStalled=function(e,t,r,i){e.stalled=!0,e.xferTimer=Math.floor(e.xferTicks/6),++e.xferStack==e.items.length&&(e.xferStack=0)},o.BufferStalled.Igor_operation="buffer.setStall",o.tick=function(e,t,r){if(0!=e.items.length&&e.active){if(e.xferTimer>0)return e.xferTimer--;if("in"==e.dir){var i=Math.min(e.xfer,e.stackSize-e.items[e.xferStack].count);if(0==i)return r.processTEMP(e,"buffer.setStall");var s=r.processTEMP("player.inventory","inventory.consume",{itemStacks:{name:e.items[e.xferStack].name,count:i},partial:!0});if(0==s[0].count)return r.processTEMP(e,"buffer.setStall");e.items[e.xferStack].count+=s[0].count,e.xferTimer=e.xferTicks*s[0].count/e.xfer}else{var n=e.items[e.xferStack];if(!r.processTEMP("player.inventory","inventory.add",{itemStacks:{name:n.name,count:Math.min(n.count,e.xfer)},stackLimit:1}).complete)return r.processTEMP(e,"buffer.setStall");n.count-=Math.min(n.count,e.xfer),e.xferTimer=e.xferTicks}++e.xferStack==e.items.length&&(e.xferStack=0),e.stalled=!1,r.getId(e.$_parent).$_tags.push("tick","processing"),r.view.signaler.signal("bufferUpdate")}},i.a.defineObj("entity.buffer",a,o);i.a.provide_CCC("research.set",(function(e,t,r){e.global.game.research.progressing=e.which.tech,e.global.game.research[e.which.tech.name]||(e.global.game.research[e.which.tech.name]={completeUnits:0})}),{which:"tech",global:"game"});i.a.provide_CCC("research.clear",(function(e,t,r){e.global.game.research.progressing=null,t.view.signaler.signal("techResearched")}),{global:"game"});i.a.addOperation("research.update",(function(e,t,r,i){var n=i.getNamedObject("global");if(n.research[e.name].completeUnits+=t.count||1,n.research[e.name].completeUnits>=e.cost.count){i.view.goodToast("Research Complete: "+e.name),r._result=n.research[e.name].completeUnits-e.cost.count,i.getNamedObject("research").progressing=null,e.researched=!0,n.research[e.name].complete=!0,e.unlocks.forEach((function(e){"string"==typeof e&&i.processTEMP(e,"recipe.unlock"),"object"==typeof e&&i.processTEMP(e,"feature.unlock")}));var c=e.cost.ingredients.map((function(e){return{name:e[0],count:e[1]}}));n.player.workshop.entities.forEach((function(e){var t=i.getId(e);"lab"==t.name&&(i.processTEMP(t.buffers.in,"inventory.add",{itemStacks:c,force:!0}),t.research_timer=NaN)})),n.facBlocks.techBlocks.forEach((function(e){if(t.me!=e){var r=i.getId(e);r.research_consumed&&(i.processTEMP(r.buffers.in,"inventory.add",{itemStacks:c,force:!0,multi:research_consumed}),r.research_consumed=0,r.research_ticks=NaN)}})),s.b.signaler.signal("techResearched")}}));i.a.addOperation("recipe.unlock",(function(e,t,r,i){i.getNamedObject("global").unlocked_recipes.push(e)}));i.a.addOperation("feature.unlock",(function(e,t,r,i){var s=i.getNamedObject("global").activeFeatures;if(s[e.feature]){
//! needs something more elegant...
if("factoryBlocks"==e.feature){var n=i.getNamedObject("global").facBlocks.blocks;e.blocksMaxSources&&n.forEach((function(t){i.getId(t).connections.maxSources=e.blocksMaxSources})),e.blocksMaxDrains&&n.forEach((function(t){i.getId(t).connections.maxDrains=e.blocksMaxDrains}))}Object.assign(s[e.feature],e)}else s[e.feature]=e}));var u=function(e,t,r){r.rec?(window.clearTimeout(r.timeout),t.processTEMP(e.player.inventory,"inventory.add",{itemStacks:r.rec.ingredients}),s.b.animsUpdate(r.rec,null,null),r.rec=void 0):t.processTEMP(e.player.inventory,"inventory.consume",{itemStacks:e.which.recipe.ingredients})?(r.rec=e.which.recipe,r.timeout=window.setTimeout((function(){t.processTEMP(e.player.inventory,"inventory.add",{itemStacks:r.rec.results}),s.b.animsUpdate(r.rec,null,null),r.rec=void 0}),1e3*e.which.recipe.crafting_speed),r.rec=e.which.recipe,s.b.animsUpdate(r.rec,"isCrafting",e.which.recipe.crafting_speed)):(t.view.warnToast("Not enough ingredients to craft"),console.log("cannot craft"))};u.signature={which:"recipe",player:"inventory"},i.a.provide_CCC("player.craft",u,u.signature)}}]);
//# sourceMappingURL=app~e525728c.20b93841ade945deec84.bundle.map