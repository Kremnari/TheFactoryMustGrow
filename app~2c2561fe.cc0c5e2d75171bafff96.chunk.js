(window.webpackJsonp=window.webpackJsonp||[]).push([[2],{"7jDb":function(e,t,n){"use strict";n.d(t,"a",(function(){return g}));var r=n("rOV7"),a=n("ztCj"),i=n("zYKg"),o=n("By/q");function s(e,t,n,r,a,i,o){try{var s=e[i](o),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function c(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var i=e.apply(t,n);function o(e){s(i,r,a,o,c,"next",e)}function c(e){s(i,r,a,o,c,"throw",e)}o(void 0)}))}}function u(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return d(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return d(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0;return function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(n=e[Symbol.iterator]()).next.bind(n)}function d(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var f={tick_entities:[],object_tickers:{},hardTickers:{},eventHandlers:{},featureDefines:{},userData:{},game:{},objs:new Map,namedObjs:[],$_tags:new i.a,meta:{},ops:{},statics:{},control:{obj_counter:0,dataSets:["TFMG_BASE_DATA"]},metaDefines:{},Tick:function(e){for(var t,n=function(){var n=t.value;if(!n._tags.tick)return"continue";var r=f.object_tickers[n.$_type].$_signalOrders;r?r.forEach((function(t){n._tags[t]&&f.object_tickers[n.$_type][t].fn(n,e,b)})):f.object_tickers[n.$_type].tick.fn(n,e,b)},r=u(f.tick_entities.values());!(t=r()).done;)n();for(var a=0,i=Object.values(f.eventHandlers.tick);a<i.length;a++){(0,i[a])(e,b)}},Tick_Builder:function(e){var t={};return Object.assign(t,e),t},IgorBuilder:l,config:{}},l={get data(){return f.data},get view(){return f.graphics},get config(){return f.config},getNamedObject:function(e){return"global"==e||"game"==e?f.game:Object.walkPath(f.game,f.namedObjs[e])},newObject:function(e,t,n){var r={$_id:"id_"+f.control.obj_counter++,$_type:e,$_subType:t,$_parent:(null==n?void 0:n.$_id)||n};return r.$_tags=Object(o.a)({to:f.$_tags,entity:r}),f.objs.set(r.$_id,r),r},newComponent:function(e,t,n){if(f.metaDefines[e]){var r=f.metaDefines[e].new(t,l.newObject(e,"",n),l),a=r[0];r[1];return f.object_tickers[e]&&f.tick_entities.push(a),a.$_id}return console.warn("cannot find object type"),!1}},g={subscribedFeatures:f.userData,gameList:[],initialize:function(e){return c(regeneratorRuntime.mark((function t(){return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return f.graphics=e.viewTasker,f.command=e.commandTasker,f.ticker=new r.a(e.ticker,f.graphics.signaler),g.Ticker=f.ticker,f.ticker_sub=f.ticker.subscribe(f.Tick),f.dbName=e.dbName,f.db=new a.a(f.dbName,"store"),g.dataSets=e.dataSets.data_files,f._provideTemp&&f._provideTemp.forEach((function(e){f.command.provide(e.item,e.fn,e.sig,e.valid)})),f._utilityTemp&&f._utilityTemp.forEach((function(e){return f.command.utilityFn(e.named,e.fn)})),f.command.provide("core.loadGame",function(){var e=c(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:console.log("loading game",t.name.game);case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),{name:"game"}),t.next=13,Object(a.d)("gameList",f.db);case 13:if(t.t0=t.sent,t.t0){t.next=16;break}t.t0=[];case 16:return g.gameList=t.t0,t.next=19,Object(a.d)("lastSaveName",f.db);case 19:f.saveName=t.sent,f.saveName?g.loadGame(f.saveName):g.newGame();case 21:case"end":return t.stop()}}),t)})))()},getDataSets:function(){return f.control.dataSets},provide_CCC:function(e,t,n,r){
//! Provides temporary passthrough for game commands
f.command?f.command.provide(e,t,n,r):(f._provideTemp||(f._provideTemp=[]),f._provideTemp.push({item:e,fn:t,sig:n,valid:r}))},CCC_addUtility:function(e,t){f.command?f.command.utilityFn(e,t):(f._utilityTemp||(f._utilityTemp=[]),f._utilityTemp.push({named:e,fn:t}))},defineObj:function(e,t,n){f.metaDefines[e]={new:t,_delete:t._delete,_signal:t._signal,actions:n},(null==n?void 0:n.tick)&&(!f.object_tickers[e]&&(f.object_tickers[e]={}),f.object_tickers[e].tick={type:e,fn:n.tick}),n&&Object.entries(n).forEach((function(e){e[0];var t=e[1];t&&t.CC_provide&&g.provide_CCC(t.CC_provide,t,t.signature,t.validator),t&&t.Igor_operation&&g.addOperation(t.Igor_operation,t),t&&t.CC_utility&&g.CCC_addUtility(t.CC_utility,t),t&&t.CC_dialogList&&g.CCC_addUtility(t.CC_dialogList,t),t.Igor_Event&&(!f.eventHandlers[t.Igor_Event.type]&&(f.eventHandlers[t.Igor_Event.type]={}),f.eventHandlers[t.Igor_Event.type][t.Igor_Event.name]=t)}))},defineFeature:function(e,t){f.featureDefines[e]=t,t&&Object.entries(t).forEach((function(e){e[0];var t=e[1];t&&(t.CC_provide&&g.provide_CCC(t.CC_provide,t,t.signature,t.validator),t.Igor_operation&&g.addOperation(t.Igor_operation,t),t.CC_utility&&g.CCC_addUtility(t.CC_utility,t),t.CC_dialogList&&g.CCC_addUtility(t.CC_dialogList,t),t.Igor_Event&&(!f.eventHandlers[t.Igor_Event.type]&&(f.eventHandlers[t.Igor_Event.type]={}),f.eventHandlers[t.Igor_Event.type][t.Igor_Event.name]=t))}))},setStatic:function(e,t){Object.defineProperty(f.statics,e,{value:t,writable:!1})},addOperation:function(e,t){f.ops[e]={fn:t}},addEventHandler:function(e,t){f.eventHandlers[e]||(f.eventHandlers[e]=[]),f.eventHandlers[e].push(t)},
//! I don't really like this implementation
addObjectTickHandler:function(e,t,n,r){!f.object_tickers[e]&&(f.object_tickers[e]={});var a=f.object_tickers[e];a[n]={type:e,fn:t,priority:r};var i=a.$_signalOrders||["tick"],o=i.findIndex((function(e){return"tick"==e}));r.chain?
//! Lots more needed for this...
[].splice.apply(i,[o,1].concat(r.chain)):r.num,a.$_signalOrders=i},loadDatabase:function(e){f.data=e},loadGame:function(e){return c(regeneratorRuntime.mark((function t(){return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,Object(a.d)(e,f.db);case 2:f.save=t.sent,f.game=JSON.parse(f.save.game),f.objs=new Map(JSON.parse(f.save.objs)),f.save.control&&(f.control=JSON.parse(f.save.control)),f.objs.forEach((function(e){e.$_tags=Object(o.a)({to:f.$_tags,entity:e,load:e.$_tags}),f.object_tickers[e.$_type]&&f.tick_entities.push(e)})),f.eventHandlers.gameLoad&&f.eventHandlers.gameLoad.forEach((function(e){return e(g)}));case 8:case"end":return t.stop()}}),t)})))()},newGame:function(e){!e&&(e={name:"SaveGame",dataSets:["TFMG_BASE_DATA"]}),f.game=f.metaDefines["#"].new,f.objs=new Map,f.control={obj_counter:0,dataSets:e.dataSets},f.saveName=e.name,g.gameList.push(e)},saveGame:function(){console.log("Game saving..."),f.eventHandlers.gameSave&&f.eventHandlers.gameSave.forEach((function(e){e(g)}));var e={game:JSON.stringify(f.game),objs:JSON.stringify(Array.from(f.objs.entries())),control:JSON.stringify(f.control)};Object(a.f)(f.saveName,e,f.db),Object(a.f)("lastSaveName",f.saveName,f.db),Object(a.f)("gameList",g.gameList,f.db)},setNamed:function(e,t){f.namedObjs[e]=t},getNamed:function(e){return"global"==e||"game"==e?f.game:Object.walkPath(f.game,f.namedObjs[e])},getObjId:function(e,t){if(!t)return f.objs.get(e);var n=f.objs.get(e);return n=Object.walkPath(n,t),f.objs.get(n)},arrayFromIds:function(e){if(!e)return[];var t=[];return e.forEach((function(e){t.push(f.objs.get(e))})),t},getRunner:function(){return b},get globalObject(){return f.game},get dataSet(){return f.data},backupSave:function(){var e={game:JSON.stringify(f.game),objs:JSON.stringify(Array.from(f.objs.entries()))};Object(a.f)("SaveGame_bak",e,f.db)},loadBackup:function(){return c(regeneratorRuntime.mark((function e(){var t;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Object(a.d)("SaveGame_bak",f.db);case 2:t=e.sent,f.game=JSON.parse(t.game),f.objs=new Map(JSON.parse(t.objs)),f.objs.forEach((function(e){e.$_tags=Object(o.a)({to:f.$_tags,entity:e,load:e.$_tags}),f.object_tickers[e.$_type]&&f.tick_entities.push(e)})),console.log("backup loaded");case 7:case"end":return e.stop()}}),e)})))()},setState:function(e){switch(e){case"start":f.graphics.signaler.signal("generalUpdate"),f.graphics.signaler.signal("entityUpdate"),f.graphics.signaler.signal("techResearched"),f.ticker.resume();break;case"stop":f.ticker.pause();break;case"tick":f.ticker.once();break;case"toggle":f.ticker.toggle(),f.ticker.isRunning&&(f.graphics.signaler.signal("generalUpdate"),f.graphics.signaler.signal("entityUpdate"),f.graphics.signaler.signal("techResearched"));break;default:console.warn("IGOR: setting unknown state")}},commands:function(e,t){return c(regeneratorRuntime.mark((function n(){var r,i;return regeneratorRuntime.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:n.t0=e,n.next="resetSave"===n.t0?3:"copySave"===n.t0?9:"storeSave"===n.t0?13:"backupSave"===n.t0?16:"restoreBackupSave"===n.t0?18:23;break;case 3:return(r=g.gameList.findIndex((function(e){return e.name==f.saveName})))>-1&&(g.gameList.splice(r,1),Object(a.f)("gameList",g.gameList,f.db)),n.next=7,Object(a.c)(f.saveName,f.db);case 7:return g.gameList.length>0?Object(a.f)("lastSaveName",g.gameList[0].name,f.db):Object(a.c)("lastSaveName",f.db),n.abrupt("return",!0);case 9:return n.next=11,Object(a.d)(f.saveName,f.db);case 11:return window.tfmg_save=n.sent,n.abrupt("return","done");case 13:return n.next=15,Object(a.f)(f.save,t,f.db);case 15:return n.abrupt("return","done");case 16:return g.backupSave(),n.abrupt("return","done");case 18:return n.next=20,Object(a.d)("SaveGame_bak",f.db);case 20:return i=n.sent,Object(a.f)(f.saveName,i,f.db),n.abrupt("return","done");case 23:case"end":return n.stop()}}),n)})))()}},b={checkAndEmit:function(e,t,n){var r=!1;if("string"!=typeof t)return f.eventHandlers[e].forEach((function(e){validator_CB(e.data)&&(e.fn(n,b),r=!0)})),r;f.eventHandlers[e][t](n,b)},get data(){return f.data},get view(){return f.graphics},get config(){return f.config},get ticker(){return f.ticker},processTEMP:function(e,t,n){var r={};if("string"==typeof e)if(e.includes("id"))e=f.objs.get(e);else{var a=b.getNamedObject(e);a&&(e=a)}return f.ops[t]||console.error("operation not found: "+t),f.ops[t].fn(e,n,r,b,f.ops[t].fn),"_result"in r?r._result:r},getNamedObject:function(e){return"global"==e||"game"==e?f.game:Object.walkPath(f.game,f.namedObjs[e])},getId:function(e,t){if(!t)return e.$_id?e:f.objs.get(e);var n=e.$_id?e:f.objs.get(e);return n=Object.walkPath(n,t),f.objs.get(n)},getStatic:function(e){return f.statics[e]},updateStatic:function(e,t){f.statics[e]=t},newComponent:function(e,t){if(f.metaDefines[e]){var n=f.metaDefines[e].new(t,l.newObject(e,""),l),r=n[0];n[1];return f.object_tickers[e]&&f.tick_entities.push(r),r.$_id}return console.warn("cannot find object type"),!1},addEventHandler:function(e,t){f.eventHandlers[e]||(f.eventHandlers[e]=[]),f.eventHandlers[e].push(t)},addNewObject:function(e,t,n){var r=f.metaDefines[t];if(r){var a=r.new(n,l.newObject(t,"",e.$_id),l),i=a[0];a[1];return!!i&&(e.push(i.$_id),f.object_tickers[t]&&f.tick_entities.push(i),r._signal&&f.graphics.signaler.signal(r._signal),!0)}return console.warn("cannot find object type"),!1},deleteObject:function(e){"string"==typeof e&&e.includes("id")&&(e=f.objs.get(e));var t=f.metaDefines[e.$_type],n=t._delete;n&&n(e,b);var r=f.tick_entities.findIndex((function(t){return t.$_id==e.$_id}));f.tick_entities.splice(r,1),f.objs.delete(e.$_id),b.view.clearShowing(),t._signal&&f.graphics.signaler.signal(t._signal)}};l.processTEMP=b.processTEMP,window.IgorCore=f},mUjK:function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var r=function(){function e(){this.iconList={}}var t=e.prototype;return t.import=function(e){this.iconList=e;for(var t=0,n=Object.entries(this.iconList.tool);t<n.length;t++){var r=n[t],a=r[0],i=r[1];this.iconList.item[a]=i}},t.getSrc=function(e,t){if(!e)return"";if(-1==e.indexOf("@"))return this.iconList.item[e];if(e.indexOf("@")>-1&&!t){var n=e.split("@");e=n[0],t=n[1]}return this.iconList[e]&&this.iconList[e][t]||this.iconList.item[t]||null},e}()},uShe:function(e,t,n){"use strict";n.d(t,"a",(function(){return l}));var r=n("+Aae"),a=n("ztCj"),i=n("XkjI"),o=n("463H");function s(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return c(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return c(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0;return function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(n=e[Symbol.iterator]()).next.bind(n)}function c(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function u(e,t,n,r,a,i,o){try{var s=e[i](o),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function d(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var i=e.apply(t,n);function o(e){u(i,r,a,o,s,"next",e)}function s(e){u(i,r,a,o,s,"throw",e)}o(void 0)}))}}var f=r.a,l={onLoadComplete:function(e){l.loadCb=e},beginLoad:function(e,t){return d(regeneratorRuntime.mark((function n(){var r,i,o,c,u,d,f,g,b,m,p,v,_,j,h;return regeneratorRuntime.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return r=new a.a(e.dbStore_name,"store"),i=["dataSet","iconSet","systemSet"],o=location.href.slice(0,location.href.lastIndexOf("/")),n.next=5,Object(a.d)("dataDates",r);case 5:if(n.t0=n.sent,n.t0){n.next=8;break}n.t0={};case 8:c=n.t0,g={dataSet:{},iconSet:{},systemSet:{}},b=!1,m=s(t);case 12:if((p=m()).done){n.next=44;break}v=p.value,_=s(i);case 15:if((j=_()).done){n.next=42;break}if(h=j.value,u=e.data_files[v],d=v+"_"+h,!u.latestDates[h]){n.next=40;break}if(c[d]&&!(c[d]<u.latestDates[h])){n.next=33;break}return console.log(h+" db out of date"),f=u[h].includes("http")?u[h]:o+"/"+u[h],n.t1=Object,n.t2=g[h],n.next=27,l.loadAndStore(f,d,r);case 27:n.t3=n.sent,n.t1.assign.call(n.t1,n.t2,n.t3),c[d]=u.latestDates[h],b=!0,n.next=40;break;case 33:return console.log(d+" db current"),n.t4=Object,n.t5=g[h],n.next=38,Object(a.d)(d,r);case 38:n.t6=n.sent,n.t4.assign.call(n.t4,n.t5,n.t6);case 40:n.next=15;break;case 42:n.next=12;break;case 44:if(n.t7=b,!n.t7){n.next=48;break}return n.next=48,Object(a.f)("dataDates",c,r);case 48:l.init(g);case 49:case"end":return n.stop()}}),n)})))()},loadAndStore:function(e,t,n){return d(regeneratorRuntime.mark((function r(){var o,s;return regeneratorRuntime.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,fetch(e);case 2:return o=r.sent,r.t0=i,r.next=6,o.text();case 6:return r.t1=r.sent,s=r.t0.parse.call(r.t0,r.t1),Object(a.f)(t,s,n),r.abrupt("return",s);case 10:case"end":return r.stop()}}),r)})))()},beginLoad2:function(e,t){return d(regeneratorRuntime.mark((function e(){var t,n,r,a,i,s,c;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=navigator.onLine,!e.t0){e.next=7;break}return e.next=4,f.idb.get("last_ds");case 4:e.t1=e.sent,e.t2=o.b,e.t0=e.t1!=e.t2;case 7:if(!e.t0){e.next=19;break}return r=location.href.slice(0,location.href.lastIndexOf("/")),e.next=11,fetch(r+"/tfmg_base_data.json");case 11:return a=e.sent,e.next=14,a.json();case 14:t=e.sent,f.idb.set("last_ds",o.b),f.idb.set("dataSet",t),e.next=22;break;case 19:return e.next=21,f.idb.get("dataSet");case 21:t=e.sent;case 22:if(e.t3=navigator.onLine,!e.t3){e.next=29;break}return e.next=26,f.idb.get("last_icon_set");case 26:e.t4=e.sent,e.t5=o.c,e.t3=e.t4!=e.t5;case 29:if(!e.t3){e.next=41;break}return i=location.href.slice(0,location.href.lastIndexOf("/")),e.next=33,fetch(i+"/tfmg_base_icons.json");case 33:return s=e.sent,e.next=36,s.json();case 36:n=e.sent,f.idb.set("last_icon_set",o.c),f.idb.set("Icons",n),e.next=44;break;case 41:return e.next=43,f.idb.get("Icons");case 43:n=e.sent;case 44:return e.next=46,f.idb.get("SaveGame");case 46:if(e.t6=e.sent,e.t6){e.next=49;break}e.t6=null;case 49:if(c=e.t6){e.next=58;break}return e.next=53,f.idb.get("SaveGame_Igor");case 53:if(e.t7=e.sent,e.t7){e.next=56;break}e.t7=null;case 56:(c=e.t7)&&!c.version&&(c.version=o.a);case 58:l.init(t,n,c);case 59:case"end":return e.stop()}}),e)})))()},init:function(e){return d(regeneratorRuntime.mark((function t(){return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:f.icon.import(e.iconSet),f.item.import(e.dataSet.item),f.data=e.dataSet,l.loadCb({mgrs:f});case 4:case"end":return t.stop()}}),t)})))()}};window.mgrs=f}}]);
//# sourceMappingURL=app~2c2561fe.cc0c5e2d75171bafff96.bundle.map