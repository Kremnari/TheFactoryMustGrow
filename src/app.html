<template>
  <require from="bootstrap/dist/css/bootstrap.min.css"></require>
  <require from="@fortawesome/fontawesome-free/css/all.min.css"></require>
  <require from="./styles.scss"></require>
  <require from="./tfmg.css"></require>

  <header id="selector">
    <div id="devControls" if.bind="showDev">
      <button click.delegate="save()">Save</button>
      <button click.delegate="resetSave()">Start Anew</button>
      <button click.delegate="mgrs.Ticker.once()">Tick 1</button>
      <button click.delegate="mgrs.Ticker.toggle()">${mgrs.Ticker.isRunning ? "Pause" : "Resume"}</button>
      <button click.delegate="testing()">Testing...</button>
      <button click.delegate="iconEditor()">Edit Icons</button>
    </div>
    <div id="playerControls">
      <h4 click.delegate="viewPane.main = 'home'">Home</h4>
      <h4 click.delegate="viewPane.main = 'entities'">Machina</h4>
      <h4 click.delegate="viewPane.main = 'facBlocks'">Blocks</h4>
      <h4 click.delegate="viewPane.main = 'research'">Research</h4>
    </div>
    <div id="facBlockControls" if.bind="viewPane.facBlock==player">
      <div show.bind="viewPane.main == 'entities'">
        <h5 click.delegate="viewPane.entityPane = 'mining'">Mining</h5>
        <h5 click.delegate="viewPane.entityPane = 'manuf'">Manufacturing</h5>
        <h5 click.delegate="viewPane.entityPane = 'labs'">Labs</h5>
      </div>
    </div>
    <require from="resources/elements/tool-tip"></require>
    <tool-tip display.bind="tooltip" item-mgr.bind="mgrs.item" recipe-mgr.bind="mgrs.rec"></tool-tip>
  </header>
  <div id="mainView" if.bind="viewPane!='iconEditor'">
    <article>
      <section id="recipes" show.bind="viewPane.main == 'home'">
        <h3>Crafting categories</h3>
        <div>
          <h4>Hand Craft</h4>
          <icon-base repeat.for="rec of mgrs.rec.recipes_by_cats['crafting']  | objectValues " item.bind="rec" click.delegate="mgrs.rec.startCraft(rec, player.inv, ' ')"
          show.bind="rec.enabled" class.bind="rec.classesStr" anim_class.bind="rec.style" mouseenter.trigger="tooltip = rec" mouseleave.trigger="tooltip = null"></icon-base>
        </div>
      </section>
      <section id="resources" show.bind="viewPane.main == 'home'">
        <h3>Mineables</h3>
        <icon-base repeat.for="res of mgrs.res.resList | canMine | objectValues" item.bind="res" click.delegate="mgrs.res.mine(res.name, player.inv)"
                  class="${res.mining ? 'mining': null}" anim_style.bind="res.miningStyle"></icon-base> 
      </section>
      <section id="technologies"  show.bind="viewPane.main == 'research'">
        <h3>Research</h3>
        <require from="./resources/elements/byModule/tech-infopane.html"></require>
        <tech-infopane if.bind="viewPane.showingCat=='tech'" tech.bind="viewPane.showingItem" tech-mgr.bind="mgrs.tech" tooltip.bind="tooltip"></tech-infopane>
        <icon-base repeat.for="tech of mgrs.tech.shownTechs & signal:'techUpdate'" click.delegate="showItem = {item: tech, cat: 'tech'}"
                    item.bind="tech" count.bind="tech.prerequisites.length"
                    class="${mgrs.tech.researching==tech ? 'researching' : ''} ${tech.researched ? 'researched': ''} ${viewPane.showingItem==tech ? 'selected': ''}"
        >
        </icon-base>
        <div>
          <h5>Filters</h5>
          <p>Filter Complete<button click.delegate="mgrs.tech.toggleFilter('complete')">${mgrs.tech.filters.ShowComplete? "Hide":"Show"}</button></p>
          <p>Filter Pack:
            <span repeat.for="pack of mgrs.tech.filters.ShowPack | objectEntries & signal:'techUpdate'"
              class="${pack[1]? 'selected':''}" click.delegate="mgrs.tech.toggleFilter('byPack', pack[0])"
              >
              <img src.bind="mgrs.icon.getSrc('item', pack[0])" height="16px">
            </span>
          </p>
        </div>
      </section>
      <section id="facBlocks" show.bind="viewPane.main == 'facBlocks'">
        <h3>Factory Blocks</h3>
        <div click.delegate="select_FacBlock(player, true)" class='${viewPane.facBlock==player ? "selected":""}'>player</div>
        <div repeat.for="facBlock of facBlocks" click.delegate="select_FacBlock(facBlock)" class='${viewPane.facBlock==facBlock ? "selected":""}'>
          ${facBlock.name}:${facBlock.type}
        </div>
        <div>
          <span class="button" click.delegate="add_FacBlock('factory')">Add Factory Block</span>
          <span class="button" click.delegate="add_FacBlock('bus')">Add Bus Block</span>
          <span class="button" click.delegate="add_FacBlock('resource')">Add Resource Block</span>
          <span class="button" click.delegate="add_FacBlock('research')">Add Lab Block</span>
        </div>
      </section>
      <section id="machines" if.bind="viewPane.main == 'entities' && viewPlayer">
        <div show.bind="viewPane.entityPane == 'mining'">
          <h4>Mining</h4>
          <require from="./resources/elements/byModule/mining-infopane.html"></require>
          <mining-infopane if.bind="viewPane.showingCat=='miner'" miner.bind="viewPane.showingItem" actor.bind="player" res-mgr.bind="mgrs.res" rounder.bind="rounder"></mining-infopane>
          <div class="entityList">
            <icon-base repeat.for="miner of viewPane.facBlock.getEntities('mining') & signal:'addedEntity'" item.bind="miner" alt-image.bind="miner.mining.icon"
                      click.delegate="showing(miner, 'miner')" class.bind="miner.selectedClass"></icon-base>
          </div>
        </div>
        <div show.bind="viewPane.entityPane == 'manuf'">
          <h4>Manufacturing</h4>
          <require from="./resources/elements/byModule/crafting-infopane.html"></require>
          <crafting-infopane if.bind="viewPane.showingCat=='crafter'" crafter.bind="viewPane.showingItem" rec-mgr.bind="mgrs.rec" item-mgr.bind="mgrs.item" actor.bind="player" inventory.bind="viewPane.facBlock.inv" rounder.bind="rounder"></crafting-infopane>
          <div class="entityList">
            <icon-base
              repeat.for="crafter of viewPane.facBlock.getEntities('crafting') & signal:'addedEntity'"
              item.bind="crafter"
              alt-image.bind="crafter.recipe.icon"
              click.delegate="showing(crafter, 'crafter')"
              class.bind="crafter.selectedClass"
            ></icon-base>
          </div>
        </div>
        <div show.bind="viewPane.entityPane == 'labs'">
          <h4>Labs</h4>
          <require from="./resources/elements/byModule/lab-infopane.html"></require>
          <lab-infopane if.bind="viewPane.showingCat=='labs'" lab.bind="viewPane.showingItem" item-mgr.bind="mgrs.item" rounder.bind="rounder"></lab-infopane>
          <div class="entityList">
            <icon-base repeat.for="labee of viewPane.facBlock.getEntities('lab') & signal:'addedEntity'" item.bind="labee" click.delegate="showing(labee, 'labs')" class.bind="labee.selectedClass"></icon-base>
          </div>
        </div>
      </section>
      <section if.bind="viewPane.main == 'entities' && !viewPlayer">
        <require from="resources/elements/factoryBlocks/transportLine.html" as="transport-line"></require>
        <require from="resources/elements/factoryBlocks/entityLine" as="entity-line"></require>
        <require from="resources/elements/factoryBlocks/TransportLineUpgrades.html" as="tlu"></require>
        Block Name: ${viewPane.facBlock.name}
        <div if.bind="viewPane.facBlock.inputLine">
          <p>
            Feed From: ${viewPane.facBlock.feeds[0].name}
            <span click.delegate="viewPane.facBlock.SelectBusFeed()">(Change)</span>
          </p>
          <transport-line
            if.bind="viewPane.facBlock.inputLine"
            line.bind="viewPane.facBlock.inputLine"
            inv-click.call="CC.InvXFer(inv, player.inv, {stacks: [item]})"
            type="input"
          ></transport-line>
          <tlu 
            upgrades.bind="viewPane.facBlock.upgrades.input"
            apply-upgrade.call="viewPane.facBlock.ApplyUpgrade({
              upgrade
              ,inv: player.inv
              ,line: viewPane.facBlock.inputLine
            })"
          ></tlu>
          <hr>
        </div>
        <div repeat.for="line of viewPane.facBlock.lines">
          <transport-line
            if.bind="line.items"
            line.bind="line"
            type="internal"
          ></transport-line>
          <entity-line
            if.bind="line.entities"
            line.bind="line"
          ></entity-line>
        </div>
        <div if.bind="viewPane.facBlock.outputLine">
          <hr>
          <p>
            Drains To: ${viewPane.facBlock.drains[0].name}
            <span click.delegate="viewPane.facBlock.SelectBusDrain()">(Change)</span>
          </p>
          <tlu
            upgrades.bind="viewPane.facBlock.upgrades.output"
            apply-upgrade.call="viewPane.facBlock.ApplyUpgrade({
              upgrade
              ,inv: player.inv
              ,line: viewPane.facBlock.outputLine
            })"
          ></tlu>
          <transport-line
            if.bind="viewPane.facBlock.outputLine"
            line.bind="viewPane.facBlock.outputLine"
            inv-click.call="CC.InvXFer(inv, player.inv, {stacks: [item]})"
            type="output"
          ></transport-line>
        </div>
      </section>
    </article>
  </div>
  <div id="iconEditor" if.bind="viewPane=='iconEditor'">
    <select value.bind="IE.select.Cat">
      <option repeat.for="cat of IE.ds.old | objectKeys & signal:'update'" model.bind="cat">${cat}</option>
    </select>
    <select value.bind="IE.select.Icon">
      <option repeat.for="icon of IE.ds.old[IE.select.Cat] | objectKeys & signal:'update'" model.bind="icon">${icon}</option>
    </select>
    <button click.delegate="IEshow()">Show</button><br>
    <figcaption class="inline">Old</figcaption>
    <img src.bind="IE.showOld & signal:'update'" height="64px" width="64px"/>
    <img src.bind="IE.showNew & signal:'update'" height="64px" width="64px"/>
    <figcaption class="inline">New</figcaption><br>
    <input type="file" files.bind="IE.file" accept="image/*" change.delegate="IEfiled()">Select replace</input>
    <img src.bind="IE.fileBlob"></img><br>
    <button click.delegate="IEStore()">Store</button>
    <button click.delegate="saveIconEditor()">SaveDB</button><br>
    <button click.delegate="dlIconEditor()">Download</button>
    <input type="file" name="name" files.bind="IE.upload" style="display:none" id="IconFileSelect" accept=".json" change.delegate="ulIconEditor()">
    <button onclick="document.getElementById('IconFileSelect').click();">Upload</button>
  </div>
  <section id="inventoryList">
    <h3>Inventory</h3>
    <inventory
      items.bind="player.inv.items"
      click-call.call="player.inv.click({
         where:viewPane.facBlock, which: item
        ,who: player, what:'use'
        })"
      ></inventory>
  </section>
  <section id="numSelectors">
    <input type="checkbox" id="numSelToggle" style="display:none">
    <label for="numSelToggle">Rounder&nbsp<span class="tabOnly">${mgrs.rounder.huns}${mgrs.rounder.tens}${mgrs.rounder.ones}</span>
    </label>
    <input id="huns" type="range" min="0" max="9" step="1" value.bind="mgrs.rounder.huns">
    <input id="tens" type="range" min="0" max="9" step="1" value.bind="mgrs.rounder.tens">
    <input id="ones" type="range" min="0" max="9" step="1" value.bind="mgrs.rounder.ones">
    <span>${mgrs.rounder.huns}${mgrs.rounder.tens}${mgrs.rounder.ones}</span>
    <label class="switch"><input type="checkbox" value.bind="mgrs.rounder.abs"><span class="slider text_abs_mod"></span></label>
    <label class="switch"><input type="checkbox" value.bind="mgrs.rounder.fail"><span class="slider text_full_part"></span></label>
  </section>

</template>
