<template>
  <scope-var var.bind="$scope={busLine: viewPane.showingItem}"></scope-var>
  <scope-var var.bind="$scope.buffer = IgorJs.getObjId($scope.busLine.processors.central)"></scope-var>
  <section
    id="viewBusLine"
    click.capture="CCC.provide($event, 'at', 'factoryBus', viewPane.showingItem)"
    mouseenter.trigger = "tooltip = null"
    class="container">
    <div class="row">
      <div class="col">
        Size: ${$scope.busLine.size}
      </div>
      <div class="col">
        <h5 class="bus_header">
          ${$scope.busLine.name}-
          <icon-base
            click.delegate="CCC.issue('factoryBus.selectSubIcon', {}, $event)"
            item.bind="$scope.busLine.subIcon"
          ></icon-base></h5>
      </div>
      <div class="col text-end">
        Complexity: ${$scope.busLine.complexity}
      </div>
    </div>
    <div class="row">
      <div class="col busLine_tut_inProgress">
        <div class="row">
          <div
            class="col"
            click.capture="CCC.provide($event, 'which', 'buffer', $scope.busLine.processors.central)"
          >
            <icon-base
              item="iron-chest"
              count.bind="$scope.buffer.upgrades.bufferSize.count & signal:'generalUpdate'"
              mouseenter.trigger="tooltip=CCC.utilityFn('facBlock.__tooltips', $scope.busLine, {which: 'bufferUpgrade', buffer: $scope.buffer})"
              click.delegate="CCC.issue(
                'entity.bufferUpgrade',
                {'type.string': 'buffer'
                ,'cost.stacks': CCC.utilityFn('facBlock.__tooltips', $scope.busLine, {which: 'bufferUpgrade', buffer: $scope.buffer}).data
                }, $event)"
            ></icon-base>
            Max stackSize: ${$scope.buffer.stackSize & signal:'generalUpdate'}
          </div>
          <span
          class="col"
          show.bind="$scope.busLine.clogged"
          click.delegate="CCC.issue('factoryBus.clearClog', {}, $event)"
          >Clear Clog</span>
        </div>
        <div class="row">
          <icon-base
            repeat.for="item of $scope.buffer.items"
            if.bind="item.count"
            item.bind="item.name"
            count.bind="item.count"
          ></icon-base>
          <span>
            Next stack at: ${Math.ceil($scope.busLine.size/50)*50}
          </span>
        </div>
      </div>
    </div>
    <hr class="bus"/>
    <div class="row">
      <div class="col">
        <div>
          <h5>Sources</h5>
          <span
            class="progressBarBase busLine_expandProcessing"
            css="border-image-source: linear-gradient(to right, green 0%, green ${$scope.busLine.processors.source.xferTimer/$scope.busLine.processors.source.xferTicks*100-10}%, red ${$scope.busLine.processors.source.xferTimer/$scope.busLine.processors.source.xferTicks*100+10}%, red )"
          >Acquisition</span>
          Qty: ${$scope.busLine.processors.source.xferQty}
          <span
            click.delegate="CCC.issue('factoryBus.expandProcessing', {'dir.string':'source'}, $event)"
            mouseenter.trigger="tooltip = CCC.utilityFn('busLine_Costs', $scope.busLine.$_id, {which: 'input_processing'})"
            class="busLine_expandProcessing fas fa-plus-square fa_icon_sm"
          ></span>
        </div>
        <span id="busLine_sources">
          Max Sources: ${$scope.busLine.connections.maxSources}
          <span 
            id="busLine_sources_add"
            mouseenter.trigger="tooltip = CCC.utilityFn('busLine_Costs', $scope.busLine.$_id, {which: 'expand_input_sources'})"
            click.delegate="CCC.issue('factoryBus.expandBus', {'dir.string':'source'}, $event)"
            class="fas fa-plus-square fa_icon_sm busLineTut_addAccessPoint"
          ></span>
        </span><br>
        <div repeat.for="source of $scope.busLine.connections.sources">
          <span
            class="fas fa-sign-in-alt fa_icon_sm"
            click.delegate="showItem = {item: source, view:'viewFacBlock'}"
          ></span>
          ${IgorJs.getObjId(source).name}
          <icon-base
            repeat.for="item of IgorJs.getObjId(source, 'buffers.out').items & signal:'generalUpdate'"
            item.bind="item.name"
            count.bind="item.count"
          ></icon-base>
          <span if.bind="$scope.busLine.processors.source.xferTarget==$index">&lt;--</span>
        </div>
      </div>
      <div class="col">
        <div>
          <h5 class="text-end">Drains</h5>
          <span
          class="progressBarBase busLine_expandProcessing"
          css="border-image-source: linear-gradient(to right, green 0%, green ${$scope.busLine.processors.drain.xferTimer/$scope.busLine.processors.drain.xferTicks*100-10}%, red ${$scope.busLine.processors.drain.xferTimer/$scope.busLine.processors.drain.xferTicks*100+10}%, red )"
          >Deposition</span>
          Qty: ${$scope.busLine.processors.drain.xferQty}
          <span
            class="fas fa-plus-square fa_icon_sm busLine_expandProcessing"
            click.delegate="CCC.issue('factoryBus.expandProcessing', {'dir.string':'drain'}, $event)"
            mouseenter.trigger="tooltip = CCC.utilityFn('busLine_Costs', $scope.busLine.$_id, {which: 'output_processing'})"
          ></span>
        </div>
        <span id="busLine_drains">
          Max Drains: ${$scope.busLine.connections.maxDrains}
          <span id="busLine_drains_add"
            click.delegate="CCC.issue('factoryBus.expandBus', {'dir.string':'drain'}, $event)"
            mouseenter.trigger="tooltip = CCC.utilityFn('busLine_Costs', $scope.busLine.$_id, {which: 'expand_output_drains'})"
            class="fas fa-plus-square fa_icon_sm busLineTut_addAccessPoint"
          ></span>
        </span>
        <br>
        <div repeat.for="drain of $scope.busLine.connections.drains">
          <span if.bind="$scope.busLine.processors.drain.xferTarget==$index">&gt;--</span>
          <span if.bind="$scope.busLine.processors.drain.xferTarget!=$index">&nbsp;&nbsp;&nbsp;</span>
          <icon-base
            repeat.for="item of IgorJs.getObjId(drain, 'buffers.in').items & signal:'generalUpdate'"
            item.bind="item.name"
            count.bind="item.count"
          ></icon-base>
          ${IgorJs.getObjId(drain).name}
          <span
            class="fas fa-sign-out-alt fa_icon_sm"
            click.delegate="showItem = {item: drain, view:'viewFacBlock'}"
          ></span>
        </div>
      </div>
    </div>
  </section>
</template>
